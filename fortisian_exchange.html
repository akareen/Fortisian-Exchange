<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fortisian Exchange</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bloomberg: {
              bg: 'rgb(38, 38, 38)',
              surface: 'rgb(38, 38, 38)',
              panel: 'rgb(30, 30, 30)',
              border: 'rgb(60, 60, 60)',
              borderLight: 'rgb(80, 80, 80)',
              orange: '#ff8c00',
              orangeDim: '#cc7000',
              green: '#00d26a',
              greenDim: '#00a854',
              red: '#ff4757',
              redDim: '#cc3945',
              white: '#ffffff',
              muted: '#888888',
              mutedDark: '#666666',
              yellow: '#ffd700',
              cyan: '#00bcd4',
            }
          },
          fontFamily: {
            mono: ['IBM Plex Mono', 'Consolas', 'Monaco', 'monospace'],
          },
        }
      }
    }
  </script>
  
  <style>
    * {
      scrollbar-width: thin;
      scrollbar-color: rgb(80, 80, 80) rgb(38, 38, 38);
    }
    *::-webkit-scrollbar { width: 8px; height: 8px; }
    *::-webkit-scrollbar-track { background: rgb(38, 38, 38); }
    *::-webkit-scrollbar-thumb { background: rgb(80, 80, 80); border-radius: 4px; }
    *::-webkit-scrollbar-thumb:hover { background: rgb(100, 100, 100); }
    
    html, body { background: rgb(38, 38, 38); }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    
    .bid-bar {
      background: linear-gradient(90deg, rgba(0, 210, 106, 0.25) var(--pct), transparent var(--pct));
    }
    .ask-bar {
      background: linear-gradient(270deg, rgba(255, 71, 87, 0.25) var(--pct), transparent var(--pct));
    }
    
    @keyframes flashGreen {
      0% { background-color: rgba(0, 210, 106, 0.4); }
      100% { background-color: transparent; }
    }
    @keyframes flashRed {
      0% { background-color: rgba(255, 71, 87, 0.4); }
      100% { background-color: transparent; }
    }
    @keyframes slideIn {
      0% { opacity: 0; transform: translateY(-8px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes tickerSlide {
      0% { opacity: 0; transform: translateX(20px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    
    .flash-green { animation: flashGreen 0.4s ease-out; }
    .flash-red { animation: flashRed 0.4s ease-out; }
    .slide-in { animation: slideIn 0.25s ease-out; }
    .pulse { animation: pulse 1.5s ease-in-out infinite; }
    .ticker-slide { animation: tickerSlide 0.3s ease-out; }
    
    .panel-border {
      border: 1px solid rgb(60, 60, 60);
    }
    
    .input-style {
      background: transparent;
      border: 1px solid rgb(80, 80, 80);
      color: #ff8c00;
      font-family: 'IBM Plex Mono', monospace;
    }
    .input-style:focus {
      outline: none;
      border-color: #ff8c00;
    }
    .input-style::placeholder {
      color: rgb(100, 100, 100);
    }
    
    .btn-buy {
      background: rgb(0, 168, 84);
      color: white;
      font-weight: 600;
      transition: all 0.15s;
    }
    .btn-buy:hover:not(:disabled) { background: rgb(0, 210, 106); }
    .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-sell {
      background: rgb(204, 57, 69);
      color: white;
      font-weight: 600;
      transition: all 0.15s;
    }
    .btn-sell:hover:not(:disabled) { background: rgb(255, 71, 87); }
    .btn-sell:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .level-row:hover { background: rgba(255, 140, 0, 0.08); }
    
    /* Chart styling */
    canvas { background: transparent !important; }
  </style>
</head>
<body class="bg-bloomberg-bg text-bloomberg-orange font-mono antialiased">
  <div id="root"></div>
  
  <!-- Audio elements -->
  <audio id="sound-tick" preload="auto">
    <source src="data:audio/wav;base64,UklGRl9vT19teleQAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU" type="audio/wav">
  </audio>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, createContext, useContext, useMemo } = React;

    // ═══════════════════════════════════════════════════════════════════════════════
    // CONFIGURATION
    // ═══════════════════════════════════════════════════════════════════════════════
    const CONFIG = {
      API_URL: 'http://localhost:8080',
      WS_URL: 'ws://localhost:8080/ws',
      RECONNECT_DELAYS: [1000, 2000, 4000, 8000, 15000, 30000],
      PING_INTERVAL: 25000,
      MAX_TRADES: 100,
      MAX_PRICE_HISTORY: 500,
      SOUND_ENABLED: true,
    };

    // ═══════════════════════════════════════════════════════════════════════════════
    // SOUND MANAGER
    // ═══════════════════════════════════════════════════════════════════════════════
    class SoundManager {
      constructor() {
        this.audioContext = null;
        this.enabled = CONFIG.SOUND_ENABLED;
        this.lastPlayTime = 0;
        this.minInterval = 100; // Minimum ms between sounds
      }
      
      init() {
        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
      }
      
      playTick(isPositive = true) {
        if (!this.enabled) return;
        const now = Date.now();
        if (now - this.lastPlayTime < this.minInterval) return;
        this.lastPlayTime = now;
        
        this.init();
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        
        osc.frequency.value = isPositive ? 880 : 440;
        osc.type = 'sine';
        
        gain.gain.setValueAtTime(0.08, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);
        
        osc.start(this.audioContext.currentTime);
        osc.stop(this.audioContext.currentTime + 0.1);
      }
      
      playAlert() {
        if (!this.enabled) return;
        this.init();
        
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        
        osc.frequency.value = 660;
        osc.type = 'square';
        
        gain.gain.setValueAtTime(0.05, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.15);
        
        osc.start(this.audioContext.currentTime);
        osc.stop(this.audioContext.currentTime + 0.15);
      }
    }
    
    const soundManager = new SoundManager();

    // ═══════════════════════════════════════════════════════════════════════════════
    // CONTEXT
    // ═══════════════════════════════════════════════════════════════════════════════
    const AppContext = createContext(null);

    // ═══════════════════════════════════════════════════════════════════════════════
    // WEBSOCKET MANAGER
    // ═══════════════════════════════════════════════════════════════════════════════
    class WebSocketManager {
      constructor(onMessage, onStatusChange) {
        this.ws = null;
        this.onMessage = onMessage;
        this.onStatusChange = onStatusChange;
        this.reconnectAttempts = 0;
        this.reconnectTimeout = null;
        this.pingInterval = null;
        this.isIntentionalClose = false;
        this.pendingMessages = [];
        this.currentMarket = null;
      }
      
      connect() {
        if (this.ws?.readyState === WebSocket.OPEN) return;
        
        this.isIntentionalClose = false;
        this.onStatusChange('connecting');
        
        try {
          this.ws = new WebSocket(CONFIG.WS_URL);
          
          this.ws.onopen = () => {
            console.log('[WS] Connected');
            this.reconnectAttempts = 0;
            this.onStatusChange('connected');
            
            // Send pending messages
            while (this.pendingMessages.length > 0) {
              const msg = this.pendingMessages.shift();
              this.send(msg.type, msg.data, msg.requestId);
            }
            
            // Resubscribe to market if we had one
            if (this.currentMarket) {
              this.send('subscribe', { market_id: this.currentMarket });
            }
            
            // Start ping
            this.startPing();
          };
          
          this.ws.onmessage = (event) => {
            try {
              const msg = JSON.parse(event.data);
              this.onMessage(msg);
            } catch (e) {
              console.error('[WS] Parse error:', e);
            }
          };
          
          this.ws.onclose = (event) => {
            console.log('[WS] Closed:', event.code, event.reason);
            this.stopPing();
            
            if (!this.isIntentionalClose) {
              this.onStatusChange('disconnected');
              this.scheduleReconnect();
            }
          };
          
          this.ws.onerror = (error) => {
            console.error('[WS] Error:', error);
          };
        } catch (e) {
          console.error('[WS] Connection failed:', e);
          this.scheduleReconnect();
        }
      }
      
      disconnect() {
        this.isIntentionalClose = true;
        this.stopPing();
        if (this.reconnectTimeout) {
          clearTimeout(this.reconnectTimeout);
          this.reconnectTimeout = null;
        }
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
        this.onStatusChange('disconnected');
      }
      
      scheduleReconnect() {
        const delay = CONFIG.RECONNECT_DELAYS[
          Math.min(this.reconnectAttempts, CONFIG.RECONNECT_DELAYS.length - 1)
        ];
        this.reconnectAttempts++;
        
        console.log(`[WS] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);
        this.onStatusChange('reconnecting');
        
        this.reconnectTimeout = setTimeout(() => this.connect(), delay);
      }
      
      startPing() {
        this.pingInterval = setInterval(() => {
          if (this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'ping' }));
          }
        }, CONFIG.PING_INTERVAL);
      }
      
      stopPing() {
        if (this.pingInterval) {
          clearInterval(this.pingInterval);
          this.pingInterval = null;
        }
      }
      
      send(type, data = {}, requestId = null) {
        const msg = { type, data };
        if (requestId) msg.request_id = requestId;
        
        if (this.ws?.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(msg));
          return true;
        } else {
          // Queue for later
          this.pendingMessages.push({ type, data, requestId });
          return false;
        }
      }
      
      subscribe(marketId) {
        this.currentMarket = marketId;
        this.send('subscribe', { market_id: marketId });
      }
      
      unsubscribe(marketId) {
        if (this.currentMarket === marketId) {
          this.currentMarket = null;
        }
        this.send('unsubscribe', { market_id: marketId });
      }
    }

    // ═══════════════════════════════════════════════════════════════════════════════
    // STATE HOOK
    // ═══════════════════════════════════════════════════════════════════════════════
    function useAppState() {
      const [state, setState] = useState({
        // Auth
        isLoggedIn: false,
        userId: '',
        displayName: '',
        isAdmin: false,
        
        // Connection
        wsStatus: 'disconnected', // disconnected, connecting, connected, reconnecting
        
        // Market
        currentMarket: 'AAPL',
        marketStatus: 'pending',
        availableMarkets: ['AAPL', 'BTCUSD', 'GOLD'],
        
        // Order Book
        bids: {}, // price (string) -> { qty, orderCount, flash }
        asks: {},
        sequence: 0,
        bestBid: null,
        bestAsk: null,
        spread: null,
        midPrice: null,
        
        // User State
        openOrders: [],
        position: { 
          net_qty: 0, 
          realized_pnl: '0', 
          total_bought: 0, 
          total_sold: 0, 
          avg_buy_price: '0',
          avg_sell_price: '0',
          trade_count: 0 
        },
        
        // Market Data
        recentTrades: [],
        priceHistory: [], // { time, price, qty, side }
        
        // Admin
        adminAlerts: [], // { id, type, data, timestamp }
        
        // UI
        notifications: [],
        lastTradePrice: null,
        lastTradeSide: null,
      });
      
      const wsManagerRef = useRef(null);
      const requestIdRef = useRef(0);
      
      // Generate unique request ID
      const getRequestId = useCallback(() => {
        requestIdRef.current++;
        return `req_${Date.now()}_${requestIdRef.current}`;
      }, []);
      
      // Update state helper
      const updateState = useCallback((updates) => {
        setState(prev => ({ ...prev, ...updates }));
      }, []);
      
      // Add notification
      const addNotification = useCallback((message, type = 'info', duration = 3000) => {
        const id = Date.now();
        setState(prev => ({
          ...prev,
          notifications: [...prev.notifications, { id, message, type }]
        }));
        if (duration > 0) {
          setTimeout(() => {
            setState(prev => ({
              ...prev,
              notifications: prev.notifications.filter(n => n.id !== id)
            }));
          }, duration);
        }
      }, []);
      
      // Add admin alert
      const addAdminAlert = useCallback((type, data) => {
        const alert = {
          id: Date.now(),
          type,
          data,
          timestamp: new Date().toISOString(),
        };
        setState(prev => ({
          ...prev,
          adminAlerts: [alert, ...prev.adminAlerts].slice(0, 50)
        }));
      }, []);
      
      // Handle WebSocket message
      const handleMessage = useCallback((msg) => {
        const { type, data, request_id } = msg;
        
        switch (type) {
          case 'book_snapshot':
            const newBids = {};
            const newAsks = {};
            (data.bids || []).forEach(level => {
              newBids[level.price] = { qty: level.qty, orderCount: level.order_count };
            });
            (data.asks || []).forEach(level => {
              newAsks[level.price] = { qty: level.qty, orderCount: level.order_count };
            });
            updateState({
              bids: newBids,
              asks: newAsks,
              sequence: data.sequence,
              bestBid: data.best_bid,
              bestAsk: data.best_ask,
              spread: data.spread,
              midPrice: data.mid_price,
            });
            break;
            
          case 'book_delta':
            setState(prev => {
              if (data.sequence <= prev.sequence) return prev;
              
              const updatedBids = { ...prev.bids };
              const updatedAsks = { ...prev.asks };
              let hasChanges = false;
              
              (data.changes || []).forEach(change => {
                const book = change.side === 'buy' ? updatedBids : updatedAsks;
                const flashType = change.side === 'buy' ? 'green' : 'red';
                
                if (change.action === 'remove' || change.qty === 0) {
                  delete book[change.price];
                } else {
                  book[change.price] = {
                    qty: change.qty,
                    orderCount: change.order_count,
                    flash: flashType,
                    flashTime: Date.now(),
                  };
                }
                hasChanges = true;
              });
              
              if (hasChanges) {
                soundManager.playTick(true);
              }
              
              return {
                ...prev,
                bids: updatedBids,
                asks: updatedAsks,
                sequence: data.sequence,
                bestBid: data.best_bid,
                bestAsk: data.best_ask,
              };
            });
            break;
            
          case 'trade':
            const trade = data.trade || data;
            setState(prev => {
              const newTrade = {
                id: trade.id || trade.trade_id || Date.now(),
                price: trade.price,
                qty: trade.qty,
                side: trade.aggressor_side,
                timestamp: trade.timestamp || new Date().toISOString(),
              };
              
              const newPricePoint = {
                time: new Date(newTrade.timestamp).getTime(),
                price: parseFloat(newTrade.price),
                qty: newTrade.qty,
                side: newTrade.side,
              };
              
              soundManager.playTick(newTrade.side === 'buy');
              
              return {
                ...prev,
                recentTrades: [newTrade, ...prev.recentTrades].slice(0, CONFIG.MAX_TRADES),
                priceHistory: [...prev.priceHistory, newPricePoint].slice(-CONFIG.MAX_PRICE_HISTORY),
                lastTradePrice: newTrade.price,
                lastTradeSide: newTrade.side,
              };
            });
            break;
            
          case 'order_accepted':
            soundManager.playAlert();
            setState(prev => {
              const newOrder = {
                orderId: data.order_id,
                marketId: data.market_id,
                side: data.side,
                price: data.price,
                qty: data.qty,
                remainingQty: data.qty,
                timeInForce: data.time_in_force,
                timestamp: data.timestamp,
              };
              
              // Admin alert
              if (prev.isAdmin) {
                addAdminAlert('order_accepted', data);
              }
              
              return {
                ...prev,
                openOrders: [...prev.openOrders, newOrder],
              };
            });
            addNotification('Order accepted', 'success');
            break;
            
          case 'order_rejected':
            soundManager.playAlert();
            addNotification(`Order rejected: ${data.reason_text || data.reason}`, 'error', 5000);
            if (state.isAdmin) {
              addAdminAlert('order_rejected', data);
            }
            break;
            
          case 'order_filled':
            soundManager.playAlert();
            setState(prev => {
              const updated = prev.openOrders.map(o => {
                if (o.orderId === data.order_id) {
                  return { ...o, remainingQty: data.remaining_qty };
                }
                return o;
              }).filter(o => o.remainingQty > 0);
              
              if (prev.isAdmin) {
                addAdminAlert('order_filled', data);
              }
              
              return { ...prev, openOrders: updated };
            });
            addNotification(`Filled ${data.fill_qty} @ ${data.fill_price}`, 'success');
            break;
            
          case 'order_cancelled':
            setState(prev => ({
              ...prev,
              openOrders: prev.openOrders.filter(o => o.orderId !== data.order_id)
            }));
            addNotification('Order cancelled', 'info');
            break;
            
          case 'order_expired':
            setState(prev => ({
              ...prev,
              openOrders: prev.openOrders.filter(o => o.orderId !== data.order_id)
            }));
            addNotification(`Order expired: ${data.reason}`, 'warning');
            break;
            
          case 'orders':
            const orders = (data.orders || []).map(o => ({
              orderId: o.order_id,
              marketId: o.market_id,
              side: o.side,
              price: o.price,
              qty: o.qty,
              remainingQty: o.remaining_qty,
              timeInForce: o.time_in_force,
            }));
            updateState({ openOrders: orders });
            break;
            
          case 'position':
            updateState({ position: data.position || data });
            break;
            
          case 'market_status':
          case 'market_status_changed':
            updateState({ marketStatus: data.new_status || data.status });
            addNotification(`Market ${data.market_id}: ${data.new_status || data.status}`, 'info');
            break;
            
          case 'subscribed':
            addNotification(`Subscribed to ${data.market_id}`, 'info', 2000);
            break;
            
          case 'error':
            addNotification(data.message || 'An error occurred', 'error', 5000);
            break;
            
          case 'pong':
            // Heartbeat response - no action needed
            break;
            
          default:
            console.log('[MSG] Unknown type:', type, data);
        }
      }, [updateState, addNotification, addAdminAlert, state.isAdmin]);
      
      // Handle WebSocket status change
      const handleStatusChange = useCallback((status) => {
        updateState({ wsStatus: status });
        if (status === 'connected') {
          addNotification('Connected to exchange', 'success', 2000);
        } else if (status === 'disconnected') {
          addNotification('Disconnected from exchange', 'warning');
        }
      }, [updateState, addNotification]);
      
      // Initialize WebSocket manager
      useEffect(() => {
        wsManagerRef.current = new WebSocketManager(handleMessage, handleStatusChange);
        return () => {
          wsManagerRef.current?.disconnect();
        };
      }, [handleMessage, handleStatusChange]);
      
      // Login
      const login = useCallback(async (userId, password) => {
        try {
          const response = await fetch(`${CONFIG.API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ user_id: userId, password }),
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            updateState({
              isLoggedIn: true,
              userId: data.user_id,
              displayName: data.display_name || data.user_id,
              isAdmin: data.is_admin || false,
            });
            
            // Connect WebSocket
            wsManagerRef.current?.connect();
            
            // Subscribe to default market
            setTimeout(() => {
              wsManagerRef.current?.subscribe(state.currentMarket);
            }, 500);
            
            return { success: true };
          } else {
            return { success: false, error: data.error || 'Login failed' };
          }
        } catch (e) {
          console.error('[Login] Error:', e);
          return { success: false, error: 'Network error. Check your connection.' };
        }
      }, [updateState, state.currentMarket]);
      
      // Logout
      const logout = useCallback(async () => {
        try {
          await fetch(`${CONFIG.API_URL}/auth/logout`, {
            method: 'POST',
            credentials: 'include',
          });
        } catch (e) {}
        
        wsManagerRef.current?.disconnect();
        
        setState({
          isLoggedIn: false,
          userId: '',
          displayName: '',
          isAdmin: false,
          wsStatus: 'disconnected',
          currentMarket: 'AAPL',
          marketStatus: 'pending',
          availableMarkets: ['AAPL', 'BTCUSD', 'GOLD'],
          bids: {},
          asks: {},
          sequence: 0,
          bestBid: null,
          bestAsk: null,
          spread: null,
          midPrice: null,
          openOrders: [],
          position: { net_qty: 0, realized_pnl: '0', total_bought: 0, total_sold: 0, avg_buy_price: '0', avg_sell_price: '0', trade_count: 0 },
          recentTrades: [],
          priceHistory: [],
          adminAlerts: [],
          notifications: [],
          lastTradePrice: null,
          lastTradeSide: null,
        });
      }, []);
      
      // Submit order
      const submitOrder = useCallback((side, price, qty, timeInForce = 'gtc') => {
        const requestId = getRequestId();
        wsManagerRef.current?.send('order_submit', {
          market_id: state.currentMarket,
          side: side.toLowerCase(),
          price: price.toString(),
          qty: parseInt(qty, 10),
          time_in_force: timeInForce.toLowerCase(),
        }, requestId);
      }, [state.currentMarket, getRequestId]);
      
      // Cancel order
      const cancelOrder = useCallback((orderId) => {
        wsManagerRef.current?.send('order_cancel', {
          market_id: state.currentMarket,
          order_id: orderId,
        });
      }, [state.currentMarket]);
      
      // Cancel all orders
      const cancelAllOrders = useCallback(() => {
        wsManagerRef.current?.send('order_cancel_all', {
          market_id: state.currentMarket,
        });
      }, [state.currentMarket]);
      
      // Switch market
      const switchMarket = useCallback((marketId) => {
        if (marketId === state.currentMarket) return;
        
        // Unsubscribe from current
        wsManagerRef.current?.unsubscribe(state.currentMarket);
        
        // Reset market data
        updateState({
          currentMarket: marketId,
          bids: {},
          asks: {},
          sequence: 0,
          bestBid: null,
          bestAsk: null,
          spread: null,
          midPrice: null,
          openOrders: [],
          recentTrades: [],
          priceHistory: [],
          lastTradePrice: null,
          lastTradeSide: null,
        });
        
        // Subscribe to new market
        wsManagerRef.current?.subscribe(marketId);
      }, [state.currentMarket, updateState]);
      
      // Clear notification
      const clearNotification = useCallback((id) => {
        setState(prev => ({
          ...prev,
          notifications: prev.notifications.filter(n => n.id !== id)
        }));
      }, []);
      
      return {
        state,
        login,
        logout,
        submitOrder,
        cancelOrder,
        cancelAllOrders,
        switchMarket,
        addNotification,
        clearNotification,
      };
    }

    // ═══════════════════════════════════════════════════════════════════════════════
    // COMPONENTS
    // ═══════════════════════════════════════════════════════════════════════════════
    
    // Login Page
    function LoginPage() {
      const { login, state } = useContext(AppContext);
      const [userId, setUserId] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!userId || !password) return;
        
        setLoading(true);
        setError('');
        
        const result = await login(userId, password);
        
        if (!result.success) {
          setError(result.error);
        }
        setLoading(false);
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center bg-bloomberg-bg">
          <div className="w-full max-w-sm">
            {/* Logo */}
            <div className="text-center mb-8">
              <div className="text-4xl font-bold text-bloomberg-orange tracking-widest mb-2">
                FORTISIAN
              </div>
              <div className="text-bloomberg-muted text-sm tracking-wider">
                TRADING EXCHANGE
              </div>
              <div className="text-bloomberg-mutedDark text-xs mt-1">
                © 2025 Fortisian Technologies
              </div>
            </div>
            
            {/* Login Form */}
            <div className="panel-border p-6" style={{ background: 'rgb(30, 30, 30)' }}>
              <form onSubmit={handleSubmit}>
                {error && (
                  <div className="mb-4 p-3 border border-bloomberg-red bg-bloomberg-red/10 text-bloomberg-red text-sm">
                    {error}
                  </div>
                )}
                
                <div className="mb-4">
                  <label className="block text-bloomberg-muted text-xs mb-2 uppercase tracking-wider">
                    User ID
                  </label>
                  <input
                    type="text"
                    value={userId}
                    onChange={(e) => setUserId(e.target.value)}
                    className="w-full px-3 py-2 input-style text-sm"
                    placeholder="Enter user ID"
                    autoFocus
                    disabled={loading}
                  />
                </div>
                
                <div className="mb-6">
                  <label className="block text-bloomberg-muted text-xs mb-2 uppercase tracking-wider">
                    Password
                  </label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full px-3 py-2 input-style text-sm"
                    placeholder="Enter password"
                    disabled={loading}
                  />
                </div>
                
                <button
                  type="submit"
                  disabled={loading || !userId || !password}
                  className="w-full py-3 bg-bloomberg-orange text-bloomberg-bg font-bold text-sm uppercase tracking-wider hover:bg-bloomberg-orangeDim disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  {loading ? 'CONNECTING...' : 'LOGIN'}
                </button>
              </form>
            </div>
            
            <div className="text-center mt-4 text-bloomberg-mutedDark text-xs">
              Secure connection required
            </div>
          </div>
        </div>
      );
    }
    
    // Header
    function Header() {
      const { state, logout, switchMarket } = useContext(AppContext);
      
      const statusColors = {
        connected: 'bg-bloomberg-green',
        connecting: 'bg-bloomberg-yellow pulse',
        reconnecting: 'bg-bloomberg-yellow pulse',
        disconnected: 'bg-bloomberg-red',
      };
      
      return (
        <header className="panel-border border-t-0 border-x-0 px-4 py-2 flex items-center justify-between" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="flex items-center gap-6">
            {/* Logo */}
            <div className="text-bloomberg-orange font-bold text-lg tracking-wider">
              FORTISIAN
            </div>
            
            {/* Market Selector */}
            <select
              value={state.currentMarket}
              onChange={(e) => switchMarket(e.target.value)}
              className="input-style px-3 py-1.5 text-sm cursor-pointer"
            >
              {state.availableMarkets.map(m => (
                <option key={m} value={m} className="bg-bloomberg-bg">{m}</option>
              ))}
            </select>
            
            {/* Connection Status */}
            <div className="flex items-center gap-2">
              <div className={`w-2 h-2 rounded-full ${statusColors[state.wsStatus]}`} />
              <span className="text-xs text-bloomberg-muted uppercase">
                {state.wsStatus}
              </span>
            </div>
            
            {/* Market Status */}
            <div className={`text-xs px-2 py-0.5 uppercase tracking-wider ${
              state.marketStatus === 'active' ? 'bg-bloomberg-green/20 text-bloomberg-green border border-bloomberg-green/30' :
              state.marketStatus === 'halted' ? 'bg-bloomberg-red/20 text-bloomberg-red border border-bloomberg-red/30' :
              'bg-bloomberg-muted/20 text-bloomberg-muted border border-bloomberg-muted/30'
            }`}>
              {state.marketStatus}
            </div>
          </div>
          
          <div className="flex items-center gap-4">
            {/* User Info */}
            <div className="text-sm">
              <span className="text-bloomberg-muted">User:</span>
              <span className="text-bloomberg-orange ml-2">{state.displayName}</span>
              {state.isAdmin && (
                <span className="ml-2 text-xs bg-bloomberg-orange/20 text-bloomberg-orange px-1.5 py-0.5 border border-bloomberg-orange/30">
                  ADMIN
                </span>
              )}
            </div>
            
            {/* Logout */}
            <button
              onClick={logout}
              className="px-3 py-1 text-xs text-bloomberg-muted hover:text-bloomberg-orange border border-bloomberg-border hover:border-bloomberg-orange transition-colors"
            >
              LOGOUT
            </button>
          </div>
        </header>
      );
    }
    
    // Market Banner
    function MarketBanner() {
      const { state } = useContext(AppContext);
      
      // Calculate stats
      const bidVolume = Object.values(state.bids).reduce((sum, b) => sum + (b.qty || 0), 0);
      const askVolume = Object.values(state.asks).reduce((sum, b) => sum + (b.qty || 0), 0);
      const openInterest = bidVolume + askVolume;
      const tradeVolume = state.recentTrades.reduce((sum, t) => sum + (t.qty || 0), 0);
      
      const lastTrade = state.recentTrades[0];
      const lastPrice = state.lastTradePrice || (lastTrade?.price) || '--';
      const lastTime = lastTrade ? new Date(lastTrade.timestamp).toLocaleTimeString('en-US', { hour12: false }) : '--:--:--';
      
      const priceChange = state.priceHistory.length >= 2
        ? (state.priceHistory[state.priceHistory.length - 1]?.price - state.priceHistory[0]?.price).toFixed(2)
        : null;
      
      return (
        <div className="panel-border border-t-0 px-4 py-3 flex items-center justify-between" style={{ background: 'rgb(30, 30, 30)' }}>
          {/* Left: Instrument Info */}
          <div className="flex items-center gap-8">
            <div>
              <div className="text-2xl font-bold text-bloomberg-white tracking-wide">
                {state.currentMarket}
              </div>
            </div>
            
            <div className="border-l border-bloomberg-border pl-6">
              <div className="text-xs text-bloomberg-muted uppercase">Last</div>
              <div className={`text-xl font-bold ${state.lastTradeSide === 'buy' ? 'text-bloomberg-green' : state.lastTradeSide === 'sell' ? 'text-bloomberg-red' : 'text-bloomberg-white'}`}>
                {lastPrice}
              </div>
            </div>
            
            {priceChange !== null && (
              <div>
                <div className="text-xs text-bloomberg-muted uppercase">Change</div>
                <div className={`text-lg font-medium ${parseFloat(priceChange) >= 0 ? 'text-bloomberg-green' : 'text-bloomberg-red'}`}>
                  {parseFloat(priceChange) >= 0 ? '+' : ''}{priceChange}
                </div>
              </div>
            )}
            
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Time</div>
              <div className="text-sm text-bloomberg-orange">{lastTime}</div>
            </div>
          </div>
          
          {/* Right: Stats */}
          <div className="flex items-center gap-8 text-sm">
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Bid</div>
              <div className="text-bloomberg-green font-medium">{state.bestBid || '--'}</div>
            </div>
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Ask</div>
              <div className="text-bloomberg-red font-medium">{state.bestAsk || '--'}</div>
            </div>
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Spread</div>
              <div className="text-bloomberg-orange font-medium">{state.spread || '--'}</div>
            </div>
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Open Int</div>
              <div className="text-bloomberg-cyan font-medium">{openInterest.toLocaleString()}</div>
            </div>
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Volume</div>
              <div className="text-bloomberg-cyan font-medium">{tradeVolume.toLocaleString()}</div>
            </div>
            <div>
              <div className="text-xs text-bloomberg-muted uppercase">Seq</div>
              <div className="text-bloomberg-muted font-medium">{state.sequence}</div>
            </div>
          </div>
        </div>
      );
    }
    
    // Order Book (Price Ladder)
    function OrderBook() {
      const { state } = useContext(AppContext);
      const [flashStates, setFlashStates] = useState({});
      
      // Combine all prices and sort descending
      const allPrices = useMemo(() => {
        const prices = new Set([
          ...Object.keys(state.bids),
          ...Object.keys(state.asks)
        ]);
        return Array.from(prices)
          .map(p => parseFloat(p))
          .sort((a, b) => b - a);
      }, [state.bids, state.asks]);
      
      // Calculate max quantities for bar widths
      const maxQty = useMemo(() => {
        const maxBid = Math.max(...Object.values(state.bids).map(b => b.qty || 0), 1);
        const maxAsk = Math.max(...Object.values(state.asks).map(a => a.qty || 0), 1);
        return Math.max(maxBid, maxAsk);
      }, [state.bids, state.asks]);
      
      // Track flash animations
      useEffect(() => {
        const now = Date.now();
        const newFlashes = {};
        
        [...Object.entries(state.bids), ...Object.entries(state.asks)].forEach(([price, level]) => {
          if (level.flashTime && now - level.flashTime < 400) {
            newFlashes[price] = level.flash;
          }
        });
        
        setFlashStates(newFlashes);
        
        if (Object.keys(newFlashes).length > 0) {
          const timeout = setTimeout(() => setFlashStates({}), 400);
          return () => clearTimeout(timeout);
        }
      }, [state.bids, state.asks]);
      
      return (
        <div className="panel-border h-full flex flex-col" style={{ background: 'rgb(30, 30, 30)' }}>
          {/* Header */}
          <div className="px-3 py-2 border-b border-bloomberg-border flex items-center justify-between">
            <span className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider">Order Book</span>
            <span className="text-xs text-bloomberg-muted">
              Spread: <span className="text-bloomberg-green">{state.spread || '--'}</span>
            </span>
          </div>
          
          {/* Column Headers */}
          <div className="grid grid-cols-3 px-3 py-1 text-xs text-bloomberg-muted uppercase border-b border-bloomberg-border bg-bloomberg-bg/50">
            <div className="text-left">Bid</div>
            <div className="text-center">Price</div>
            <div className="text-right">Ask</div>
          </div>
          
          {/* Price Ladder */}
          <div className="flex-1 overflow-y-auto">
            {allPrices.length === 0 ? (
              <div className="flex items-center justify-center h-full text-bloomberg-muted text-sm">
                No orders in book
              </div>
            ) : (
              allPrices.map(price => {
                const priceStr = price.toFixed(2);
                const bid = state.bids[priceStr];
                const ask = state.asks[priceStr];
                const bidQty = bid?.qty || 0;
                const askQty = ask?.qty || 0;
                const bidPct = ((bidQty / maxQty) * 100).toFixed(0);
                const askPct = ((askQty / maxQty) * 100).toFixed(0);
                
                const isBestBid = priceStr === state.bestBid;
                const isBestAsk = priceStr === state.bestAsk;
                const flashClass = flashStates[priceStr] === 'green' ? 'flash-green' : flashStates[priceStr] === 'red' ? 'flash-red' : '';
                
                return (
                  <div
                    key={priceStr}
                    className={`grid grid-cols-3 px-3 py-0.5 text-sm level-row ${flashClass}`}
                  >
                    {/* Bid */}
                    <div 
                      className="text-left text-bloomberg-green bid-bar pr-2"
                      style={{ '--pct': `${bidPct}%` }}
                    >
                      {bidQty > 0 && (
                        <span className={isBestBid ? 'font-bold' : ''}>
                          {bidQty.toLocaleString()}
                        </span>
                      )}
                    </div>
                    
                    {/* Price */}
                    <div className={`text-center font-medium ${
                      isBestBid ? 'text-bloomberg-green' : 
                      isBestAsk ? 'text-bloomberg-red' : 
                      'text-bloomberg-white'
                    }`}>
                      {priceStr}
                    </div>
                    
                    {/* Ask */}
                    <div 
                      className="text-right text-bloomberg-red ask-bar pl-2"
                      style={{ '--pct': `${askPct}%` }}
                    >
                      {askQty > 0 && (
                        <span className={isBestAsk ? 'font-bold' : ''}>
                          {askQty.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );
    }
    
    // Price Chart
    function PriceChart() {
      const { state } = useContext(AppContext);
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      
      useEffect(() => {
        if (!canvasRef.current) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
          chartRef.current.destroy();
        }
        
        const data = state.priceHistory.map(p => ({
          x: p.time,
          y: p.price,
        }));
        
        chartRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Price',
              data: data,
              borderColor: '#ff8c00',
              backgroundColor: 'rgba(255, 140, 0, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.1,
              pointRadius: 0,
              pointHoverRadius: 6,
              pointHoverBackgroundColor: '#ff8c00',
              pointHoverBorderColor: '#fff',
              pointHoverBorderWidth: 2,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: 'rgb(30, 30, 30)',
                borderColor: 'rgb(60, 60, 60)',
                borderWidth: 1,
                titleColor: '#ff8c00',
                bodyColor: '#ffffff',
                titleFont: {
                  family: 'IBM Plex Mono',
                  size: 11,
                },
                bodyFont: {
                  family: 'IBM Plex Mono',
                  size: 12,
                },
                padding: 10,
                displayColors: false,
                callbacks: {
                  title: (items) => {
                    if (items.length > 0) {
                      return new Date(items[0].raw.x).toLocaleTimeString('en-US', { hour12: false });
                    }
                    return '';
                  },
                  label: (item) => `Price: $${item.raw.y.toFixed(2)}`,
                }
              },
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  displayFormats: {
                    second: 'HH:mm:ss',
                    minute: 'HH:mm',
                    hour: 'HH:mm',
                  }
                },
                grid: {
                  color: 'rgba(60, 60, 60, 0.5)',
                  drawBorder: false,
                },
                ticks: {
                  color: '#888888',
                  font: {
                    family: 'IBM Plex Mono',
                    size: 10,
                  },
                  maxRotation: 0,
                },
              },
              y: {
                grid: {
                  color: 'rgba(60, 60, 60, 0.5)',
                  drawBorder: false,
                },
                ticks: {
                  color: '#888888',
                  font: {
                    family: 'IBM Plex Mono',
                    size: 10,
                  },
                  callback: (value) => '$' + value.toFixed(2),
                },
              },
            },
          },
        });
        
        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [state.priceHistory]);
      
      return (
        <div className="panel-border h-full flex flex-col" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="px-3 py-2 border-b border-bloomberg-border">
            <span className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider">Price Chart</span>
          </div>
          <div className="flex-1 p-2 min-h-0">
            {state.priceHistory.length === 0 ? (
              <div className="flex items-center justify-center h-full text-bloomberg-muted text-sm">
                Waiting for trades...
              </div>
            ) : (
              <canvas ref={canvasRef} />
            )}
          </div>
        </div>
      );
    }
    
    // Order Entry
    function OrderEntry() {
      const { submitOrder, state } = useContext(AppContext);
      const [price, setPrice] = useState('');
      const [qty, setQty] = useState('');
      const [tif, setTif] = useState('gtc');
      const [submitting, setSubmitting] = useState(false);
      
      const handleSubmit = (side) => {
        if (!price || !qty || submitting) return;
        
        setSubmitting(true);
        submitOrder(side, price, qty, tif);
        
        setTimeout(() => {
          setSubmitting(false);
          setPrice('');
          setQty('');
        }, 200);
      };
      
      const disabled = submitting || !price || !qty || state.marketStatus !== 'active';
      
      return (
        <div className="panel-border p-3" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider mb-3">
            Order Entry
          </div>
          
          <div className="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label className="block text-xs text-bloomberg-muted uppercase mb-1">Price</label>
              <input
                type="text"
                value={price}
                onChange={(e) => setPrice(e.target.value)}
                placeholder="0.00"
                className="w-full px-2 py-1.5 input-style text-sm"
                disabled={submitting}
              />
            </div>
            <div>
              <label className="block text-xs text-bloomberg-muted uppercase mb-1">Quantity</label>
              <input
                type="number"
                value={qty}
                onChange={(e) => setQty(e.target.value)}
                placeholder="0"
                className="w-full px-2 py-1.5 input-style text-sm"
                disabled={submitting}
              />
            </div>
          </div>
          
          <div className="mb-3">
            <label className="block text-xs text-bloomberg-muted uppercase mb-1">Time in Force</label>
            <select
              value={tif}
              onChange={(e) => setTif(e.target.value)}
              className="w-full px-2 py-1.5 input-style text-sm cursor-pointer"
              disabled={submitting}
            >
              <option value="gtc" className="bg-bloomberg-bg">GTC - Good Till Cancel</option>
              <option value="ioc" className="bg-bloomberg-bg">IOC - Immediate or Cancel</option>
              <option value="fok" className="bg-bloomberg-bg">FOK - Fill or Kill</option>
            </select>
          </div>
          
          <div className="grid grid-cols-2 gap-3">
            <button
              onClick={() => handleSubmit('buy')}
              disabled={disabled}
              className="py-2.5 btn-buy text-sm uppercase tracking-wider"
            >
              Buy
            </button>
            <button
              onClick={() => handleSubmit('sell')}
              disabled={disabled}
              className="py-2.5 btn-sell text-sm uppercase tracking-wider"
            >
              Sell
            </button>
          </div>
        </div>
      );
    }
    
    // Position Display
    function PositionDisplay() {
      const { state } = useContext(AppContext);
      const { position } = state;
      
      const netQty = position.net_qty || 0;
      const pnl = parseFloat(position.realized_pnl || '0');
      
      return (
        <div className="panel-border p-3" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider mb-3">
            Position
          </div>
          
          <div className="space-y-2">
            <div className="flex justify-between">
              <span className="text-bloomberg-muted text-sm">Net Position</span>
              <span className={`font-bold ${netQty > 0 ? 'text-bloomberg-green' : netQty < 0 ? 'text-bloomberg-red' : 'text-bloomberg-white'}`}>
                {netQty > 0 ? '+' : ''}{netQty}
              </span>
            </div>
            
            <div className="flex justify-between">
              <span className="text-bloomberg-muted text-sm">Realized P&L</span>
              <span className={`font-bold ${pnl > 0 ? 'text-bloomberg-green' : pnl < 0 ? 'text-bloomberg-red' : 'text-bloomberg-white'}`}>
                ${pnl >= 0 ? '+' : ''}{pnl.toFixed(2)}
              </span>
            </div>
            
            <div className="border-t border-bloomberg-border pt-2 mt-2 space-y-1">
              <div className="flex justify-between text-xs">
                <span className="text-bloomberg-muted">Bought</span>
                <span className="text-bloomberg-green">{position.total_bought || 0}</span>
              </div>
              <div className="flex justify-between text-xs">
                <span className="text-bloomberg-muted">Sold</span>
                <span className="text-bloomberg-red">{position.total_sold || 0}</span>
              </div>
              <div className="flex justify-between text-xs">
                <span className="text-bloomberg-muted">Trades</span>
                <span className="text-bloomberg-orange">{position.trade_count || 0}</span>
              </div>
            </div>
          </div>
        </div>
      );
    }
    
    // Open Orders
    function OpenOrders() {
      const { state, cancelOrder, cancelAllOrders } = useContext(AppContext);
      
      return (
        <div className="panel-border p-3" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="flex items-center justify-between mb-3">
            <span className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider">
              Open Orders ({state.openOrders.length})
            </span>
            {state.openOrders.length > 0 && (
              <button
                onClick={cancelAllOrders}
                className="text-xs px-2 py-1 text-bloomberg-red border border-bloomberg-red/50 hover:bg-bloomberg-red/10 transition-colors"
              >
                Cancel All
              </button>
            )}
          </div>
          
          {state.openOrders.length === 0 ? (
            <div className="text-bloomberg-muted text-sm text-center py-4">
              No open orders
            </div>
          ) : (
            <div className="space-y-1 max-h-40 overflow-y-auto">
              {state.openOrders.map(order => (
                <div
                  key={order.orderId}
                  className="flex items-center justify-between py-1.5 px-2 bg-bloomberg-bg border border-bloomberg-border/50 slide-in"
                >
                  <div className="flex items-center gap-2 text-sm">
                    <span className={`font-bold ${order.side === 'buy' ? 'text-bloomberg-green' : 'text-bloomberg-red'}`}>
                      {order.side.toUpperCase()}
                    </span>
                    <span className="text-bloomberg-white">{order.remainingQty}</span>
                    <span className="text-bloomberg-muted">@</span>
                    <span className="text-bloomberg-orange">{order.price}</span>
                  </div>
                  <button
                    onClick={() => cancelOrder(order.orderId)}
                    className="text-bloomberg-red hover:bg-bloomberg-red/20 px-1.5 py-0.5 transition-colors"
                  >
                    ✕
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }
    
    // Recent Trades
    function RecentTrades() {
      const { state } = useContext(AppContext);
      
      return (
        <div className="panel-border h-full flex flex-col" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="px-3 py-2 border-b border-bloomberg-border">
            <span className="text-bloomberg-orange font-bold text-sm uppercase tracking-wider">Recent Trades</span>
          </div>
          
          {/* Column Headers */}
          <div className="grid grid-cols-4 px-3 py-1 text-xs text-bloomberg-muted uppercase border-b border-bloomberg-border bg-bloomberg-bg/50">
            <div>Time</div>
            <div className="text-right">Price</div>
            <div className="text-right">Qty</div>
            <div className="text-right">Side</div>
          </div>
          
          <div className="flex-1 overflow-y-auto">
            {state.recentTrades.length === 0 ? (
              <div className="flex items-center justify-center h-full text-bloomberg-muted text-sm">
                No trades yet
              </div>
            ) : (
              state.recentTrades.map((trade, idx) => {
                const time = new Date(trade.timestamp).toLocaleTimeString('en-US', { hour12: false });
                const isNew = idx === 0;
                
                return (
                  <div
                    key={trade.id}
                    className={`grid grid-cols-4 px-3 py-0.5 text-sm border-b border-bloomberg-border/30 ${isNew ? 'ticker-slide' : ''}`}
                  >
                    <div className="text-bloomberg-muted">{time}</div>
                    <div className={`text-right ${trade.side === 'buy' ? 'text-bloomberg-green' : 'text-bloomberg-red'}`}>
                      {trade.price}
                    </div>
                    <div className="text-right text-bloomberg-white">{trade.qty}</div>
                    <div className={`text-right ${trade.side === 'buy' ? 'text-bloomberg-green' : 'text-bloomberg-red'}`}>
                      {trade.side?.toUpperCase()}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );
    }
    
    // Admin Alerts Panel (only shown to admins)
    function AdminAlerts() {
      const { state } = useContext(AppContext);
      
      if (!state.isAdmin || state.adminAlerts.length === 0) return null;
      
      return (
        <div className="panel-border p-3 mt-3" style={{ background: 'rgb(30, 30, 30)' }}>
          <div className="text-bloomberg-yellow font-bold text-sm uppercase tracking-wider mb-2">
            Admin Alerts
          </div>
          <div className="space-y-1 max-h-32 overflow-y-auto">
            {state.adminAlerts.slice(0, 10).map(alert => (
              <div key={alert.id} className="text-xs p-2 bg-bloomberg-bg border border-bloomberg-border/50 slide-in">
                <div className="flex items-center justify-between">
                  <span className={`font-bold ${
                    alert.type === 'order_accepted' ? 'text-bloomberg-green' :
                    alert.type === 'order_rejected' ? 'text-bloomberg-red' :
                    alert.type === 'order_filled' ? 'text-bloomberg-cyan' :
                    'text-bloomberg-orange'
                  }`}>
                    {alert.type.toUpperCase().replace('_', ' ')}
                  </span>
                  <span className="text-bloomberg-muted">
                    {new Date(alert.timestamp).toLocaleTimeString('en-US', { hour12: false })}
                  </span>
                </div>
                <div className="text-bloomberg-muted mt-1">
                  {alert.data.user_id && <span>User: {alert.data.user_id} | </span>}
                  {alert.data.side && <span>{alert.data.side.toUpperCase()} </span>}
                  {alert.data.qty && <span>{alert.data.qty} </span>}
                  {alert.data.price && <span>@ {alert.data.price}</span>}
                  {alert.data.fill_qty && <span>Fill: {alert.data.fill_qty} @ {alert.data.fill_price}</span>}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }
    
    // Notifications
    function Notifications() {
      const { state, clearNotification } = useContext(AppContext);
      
      if (state.notifications.length === 0) return null;
      
      const typeStyles = {
        success: 'bg-bloomberg-green/90 text-white',
        error: 'bg-bloomberg-red/90 text-white',
        warning: 'bg-bloomberg-yellow/90 text-bloomberg-bg',
        info: 'bg-bloomberg-orange/90 text-bloomberg-bg',
      };
      
      return (
        <div className="fixed top-4 right-4 z-50 space-y-2">
          {state.notifications.map(n => (
            <div
              key={n.id}
              className={`px-4 py-2 text-sm font-medium slide-in shadow-lg ${typeStyles[n.type]}`}
              onClick={() => clearNotification(n.id)}
              style={{ cursor: 'pointer' }}
            >
              {n.message}
            </div>
          ))}
        </div>
      );
    }
    
    // Main Trading Page
    function TradingPage() {
      return (
        <div className="min-h-screen bg-bloomberg-bg flex flex-col">
          <Header />
          <MarketBanner />
          
          <main className="flex-1 p-2 grid grid-cols-12 gap-2" style={{ height: 'calc(100vh - 110px)' }}>
            {/* Left: Order Book */}
            <div className="col-span-4" style={{ height: 'calc(100vh - 130px)' }}>
              <OrderBook />
            </div>
            
            {/* Center: Chart + Order Entry */}
            <div className="col-span-4 flex flex-col gap-2">
              <div style={{ height: '45%' }}>
                <PriceChart />
              </div>
              <div className="flex-1 space-y-2 overflow-auto">
                <OrderEntry />
                <PositionDisplay />
                <AdminAlerts />
              </div>
            </div>
            
            {/* Right: Open Orders + Trades */}
            <div className="col-span-4 flex flex-col gap-2">
              <div>
                <OpenOrders />
              </div>
              <div className="flex-1" style={{ minHeight: '200px' }}>
                <RecentTrades />
              </div>
            </div>
          </main>
          
          <Notifications />
        </div>
      );
    }
    
    // App
    function App() {
      const appState = useAppState();
      
      return (
        <AppContext.Provider value={appState}>
          {appState.state.isLoggedIn ? <TradingPage /> : <LoginPage />}
        </AppContext.Provider>
      );
    }
    
    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
